#!/bin/bash

# Color Definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
APP_ID="1941110" #App_ID for Rei
SOURCE="/Volumes/Higu_Ch9_Kor/Data/Contents"
GRID_IMAGES_SOURCE="/Volumes/Higu_Ch9_Kor/Data/Steamgrid"
STEAM_CONFIG_FILE="$HOME/Library/Application Support/Steam/config/libraryfolders.vdf"

# Function to get chapter name
get_chapter_name() {
  case "$1" in
    "310360") echo "ì˜¤ë‹ˆì¹´ì¿ ì‹œ í¸" ;;
    "410890") echo "ì™€íƒ€ë‚˜ê°€ì‹œ í¸" ;;
    "472870") echo "íƒ€íƒ€ë¦¬ê³ ë¡œì‹œ í¸" ;;
    "526490") echo "íˆë§ˆì¸ ë¶€ì‹œ í¸" ;;
    "577480") echo "ë©”ì•„ì¹´ì‹œ í¸" ;;
    "668350") echo "ì¸ ë¯¸í˜¸ë¡œë³´ì‹œ í¸" ;;
    "1034940") echo "ë¯¸ë‚˜ê³ ë¡œì‹œ í¸" ;;
    "1243670") echo "ë§ˆì¸ ë¦¬ë°”ì•¼ì‹œ í¸" ;;
    "1941110") echo "ì“°ë¥´ë¼ë¯¸ ìš¸ ì ì—: ë¡€" ;;
    "2491040") echo "ì“°ë¥´ë¼ë¯¸ ìš¸ ì ì—: ë´‰+" ;;
    *) return 1 ;;
  esac
}

# Welcome Screen
show_welcome() {
  echo -e "${CYAN}"
  echo "ì œì‘ì: Montmorency (https://github.com/s485lee)"
  echo ""
  echo "ì‚¬ìš© ì•ˆë‚´:"
  echo "- SteamíŒ: ì¸ìŠ¤í†¨ëŸ¬ì˜ ì•ˆë‚´ë¥¼ ë”°ë¼ì£¼ì„¸ìš”."
  echo "- GOG/MangaGameríŒ: í•´ë‹¹ íŒì„ ì‚¬ìš© ì¤‘ì´ë¼ë©´, ì¸ìŠ¤í†¨ëŸ¬ì˜ ì•ˆë‚´ì— ë”°ë¼ ê²Œì„ .app íŒŒì¼ì„ ì¸ìŠ¤í†¨ëŸ¬ ì°½ìœ¼ë¡œ ë“œë˜ê·¸í•´ ì£¼ì„¸ìš”. Compatibility Packì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‹ˆ, ìì„¸í•œ ë‚´ìš©ì€ 07th-Mod ìœ„í‚¤ë¥¼ ì°¸ê³ í•˜ì„¸ìš”."
  echo -e "${NC}"
}

# UI Functions
print_header() {
  local chapter_name
  chapter_name=$(get_chapter_name "$APP_ID")
  clear
  echo -e "${GREEN}================================================================"
  echo " macOSìš© ì“°ë¥´ë¼ë¯¸ ìš¸ ì ì— í•œê¸€íŒ¨ì¹˜ ì¸ìŠ¤í†¨ëŸ¬: ${chapter_name}"
  echo -e "================================================================${NC}"
}

section_header() {
  echo -e "\n${BLUE}===[ $1 ]===${NC}"
}

print_footer() {
  echo -e "\n${GREEN}=============================================="
  echo "í•˜ìš°~â˜†! ì˜¤ëª¨ì¹˜ì¹´ì—ë¦¬~!"
  echo "í•œê¸€íŒ¨ì¹˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."
  echo "ê²Œì„ì„ Steamì—ì„œ ì‹¤í–‰í•´ ì£¼ì„¸ìš”. ë‹ˆíŒŒ~â˜†"
  echo -e "==============================================${NC}"
  echo -e "${YELLOW}\nì¢…ë£Œí•˜ë ¤ë©´ ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ì„¸ìš”...${NC}"
  read -n 1 -s -r
}

# Function to find game path
find_game_path() {
  local app_id=$1
  local file_path=$2
  local game_path=""
  local current_path=""

  if [[ ! -f "$file_path" ]]; then
    return 1
  fi

  while read -r line; do
    if [[ "$line" =~ \"path\" ]]; then
      current_path=$(echo "$line" | sed -E 's/.*\"path\"[[:space:]]+\"([^\"]+)\".*/\1/')
    fi
    if [[ "$line" =~ \"$app_id\" ]]; then
      game_path="$current_path"
      break
    fi
  done < "$file_path"

  if [[ -z "$game_path" ]]; then
    return 1
  fi

  case "$app_id" in
    "310360") echo "$game_path/steamapps/common/Higurashi When They Cry" ;;
    "410890") echo "$game_path/steamapps/common/Higurashi 02 - Watanagashi" ;;
    "472870") echo "$game_path/steamapps/common/Higurashi 03 - Tatarigoroshi" ;;
    "526490") echo "$game_path/steamapps/common/Higurashi 04 - Himatsubushi" ;;
    "577480") echo "$game_path/steamapps/common/Higurashi When They Cry Hou - Ch. 5 Meakashi" ;;
    "668350") echo "$game_path/steamapps/common/Higurashi When They Cry Hou - Ch.6 Tsumihoroboshi" ;;
    "1034940") echo "$game_path/steamapps/common/Higurashi When They Cry Hou - Ch.7 Minagoroshi" ;;
    "1243670") echo "$game_path/steamapps/common/Higurashi When They Cry Hou - Ch.8 Matsuribayashi" ;;
    "1941110") echo "$game_path/steamapps/common/Higurashi When They Cry Hou - Rei" ;;
    "2491040") echo "$game_path/steamapps/common/Higurashi When They Cry Hou+" ;;
    *) return 1 ;;
  esac
  return 0
}

# Function to get app name 
get_app_name() {
  case "$1" in
    "310360") echo "HigurashiEp01.app" ;;
    "410890") echo "HigurashiEp02.app" ;;
    "472870") echo "HigurashiEp03.app" ;;
    "526490") echo "HigurashiEp04.app" ;;
    "577480") echo "HigurashiEp05.app" ;;
    "668350") echo "HigurashiEp06.app" ;;
    "1034940") echo "HigurashiEp07.app" ;;
    "1243670") echo "HigurashiEp08.app" ;;
    "1941110") echo "HigurashiEp09.app" ;;
    "2491040") echo "HigurashiEp10.app" ;;
    *) return 1 ;;
  esac
  return 0
}

# Main execution
print_header
show_welcome

section_header "Steam í™•ì¸"
if [[ ! -f "$STEAM_CONFIG_FILE" ]]; then
  echo -e "${RED}ê²½ê³ : Steamì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤${NC}"
else
  echo -e "${GREEN}Steam í™•ì¸ ì„±ê³µ${NC}"
fi

# Path detection logic
section_header "ê²Œì„ ê²½ë¡œ í™•ì¸"
BASE_DESTINATION=$(find_game_path "$APP_ID" "$STEAM_CONFIG_FILE")
APP_NAME=$(get_app_name "$APP_ID")

if [[ -n "$BASE_DESTINATION" && ! -d "$BASE_DESTINATION/$APP_NAME" ]]; then
  echo -e "${YELLOW}ê²½ê³ : $APP_NAME ì„ ë‹¤ìŒ ê²½ë¡œì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $BASE_DESTINATION${NC}"
  BASE_DESTINATION=""
fi

if [[ -z "$BASE_DESTINATION" || ! -d "$BASE_DESTINATION/$APP_NAME" ]]; then
  section_header "ìˆ˜ë™ ê²½ë¡œ ì„¤ì •"
  while true; do
    echo -e "${YELLOW}íŒ¨ì¹˜ ì¸ìŠ¤í†¨ëŸ¬ê°€ ìë™ìœ¼ë¡œ ê²Œì„ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
    echo -e "${CYAN}$APP_NAME ì„ íŒ¨ì¹˜ ì¸ìŠ¤í†¨ëŸ¬ ì°½ìœ¼ë¡œ ë“œë˜ê·¸ í•´ì£¼ì„¸ìš”:${NC}"
    read -r app_path
    app_path=$(echo "$app_path" | sed 's/\\//g')
    app_name=$(basename "$app_path")
    
    if [[ $app_name == "$APP_NAME" ]]; then
      if [[ -d "$app_path/Contents" ]]; then
        DESTINATION="$app_path/Contents"
        echo -e "${GREEN}$APP_NAME í™•ì¸ ì„±ê³µ!${NC}"
        break
      else
        echo -e "${RED}ê²½ê³ : .app íŒŒì¼ì´ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
      fi
    else
      echo -e "${RED}ì˜ëª»ëœ íŒŒì¼ì…ë‹ˆë‹¤. ë‹¤ìŒ íŒŒì¼ì„ ë“œë˜ê·¸ í•´ì£¼ì„¸ìš”: ${CYAN}$APP_NAME${NC}"
    fi
  done
else
  DESTINATION="$BASE_DESTINATION/$APP_NAME/Contents"
  echo -e "${GREEN}ê²Œì„ ê²½ë¡œ í™•ì¸ ì„±ê³µ: ${DESTINATION}${NC}"
fi

echo -e "\në‹¤ìŒ ê²½ë¡œì— í•œê¸€íŒ¨ì¹˜ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤:\n${CYAN}${DESTINATION}${NC}"

# Input validation loop
while true; do
    echo -en "${YELLOW}í•œê¸€íŒ¨ì¹˜ë¥¼ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? [y/n] ${NC}"
    read -r user_confirm
    case "$user_confirm" in
        [yY]|[nN]) 
            break
            ;;
        *)
            echo -e "${RED}\nì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. y ë˜ëŠ” n ë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.${NC}"
            sleep 1
            ;;
    esac
done

if [[ $user_confirm == "y" || $user_confirm == "Y" ]]; then
section_header "íŒ¨ì¹˜ ì„¤ì¹˜ ì§„í–‰"

# Calculate source size for progress
total_kb=$(du -sk "$SOURCE" | awk '{print $1}')
[[ $total_kb -eq 0 ]] && total_kb=1 # Prevent division by zero

rsync -av "$SOURCE/" "$DESTINATION" > "$DESTINATION/Patch Install rsync.log" 2>&1 &
pid=$!
spin=('ğŸ•›' 'ğŸ•' 'ğŸ•‘' 'ğŸ•’' 'ğŸ•“' 'ğŸ•”' 'ğŸ••' 'ğŸ•–' 'ğŸ•—' 'ğŸ•˜' 'ğŸ•™' 'ğŸ•š')
i=0

while kill -0 $pid 2>/dev/null; do
    i=$(( (i+1) %12 ))
    # Get current transferred size
    current_kb=$(du -sk "$DESTINATION" 2>/dev/null | awk '{print $1}')
    # Calculate percentage (capped at 99% during transfer)
    percentage=$(( (current_kb * 100) / total_kb ))
    (( percentage > 99 )) && percentage=99
    echo -ne "\r${spin[$i]} ${BLUE}í•œê¸€íŒ¨ì¹˜ ì„¤ì¹˜ ì§„í–‰ ì¤‘... ${percentage}%${NC}"
    sleep 0.3
done
echo -ne "\r\033[K" 
echo -e "âœ… ${GREEN}í•œê¸€íŒ¨ì¹˜ ì„¤ì¹˜ ì™„ë£Œ (100%)${NC}"

# Steamgrid images installation with progress
section_header "Steamgrid ì´ë¯¸ì§€ ì„¤ì¹˜"
grid_total_kb=$(du -sk "$GRID_IMAGES_SOURCE" | awk '{print $1}')
[[ $grid_total_kb -eq 0 ]] && grid_total_kb=1

USERDATA_DIR="$HOME/Library/Application Support/Steam/userdata/"
for USER_DIR in "$USERDATA_DIR"[0-9]*/; do
    GRID_DESTINATION="${USER_DIR}config/grid/"
    mkdir -p "$GRID_DESTINATION"
    
    rsync -av "$GRID_IMAGES_SOURCE/" "$GRID_DESTINATION" > "$DESTINATION/steamgrid_rsync.log" 2>&1 &
    pid=$!
    i=0
    
    while kill -0 $pid 2>/dev/null; do
        i=$(( (i+1) %12 ))
        current_grid_kb=$(du -sk "$GRID_DESTINATION" 2>/dev/null | awk '{print $1}')
        grid_percentage=$(( (current_grid_kb * 100) / grid_total_kb ))
        (( grid_percentage > 99 )) && grid_percentage=99
        echo -ne "\r${spin[$i]} ${BLUE}Steamgrid ì´ë¯¸ì§€ ì„¤ì¹˜ ì¤‘... ${grid_percentage}%${NC}"
        sleep 0.3
    done

    # Clear the line and print the final message
    echo -ne "\r\033[K"
    echo -e "âœ… ${GREEN}Steamgrid ì´ë¯¸ì§€ ì„¤ì¹˜ ì™„ë£Œ (100%)${NC}"
done

print_footer

else
  echo -e "${RED}ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
  echo -e "${YELLOW}ì¢…ë£Œí•˜ë ¤ë©´ ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ì„¸ìš”...${NC}"
  read -n 1 -s -r
fi